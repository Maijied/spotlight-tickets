name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Create .env file
      run: |
        cat > .env << EOF
        # Database Configuration
        DB_HOST=sql303.infinityfree.com
        DB_NAME=if0_40819537_shiddarth
        DB_USER=if0_40819537
        DB_PASS=fWNDOUzsifw8yGh
        
        # Payment Configuration
        BKASH_NUMBER=01968833917
        PAYMENT_MODE=MANUAL
        
        # Application Settings
        EVENT_NAME=Siddhartha Live 2026
        ADMIN_EMAIL=admin@example.com
        EOF
        
    - name: Deploy via FTP (lftp)
      run: |
        sudo apt-get update
        sudo apt-get install -y lftp
        
        lftp -c "
        set ftp:ssl-allow no;
        set ftp:passive-mode on;
        open -u ${{ secrets.FTP_USERNAME }},${{ secrets.FTP_PASSWORD }} ${{ secrets.FTP_SERVER }};
        mirror --reverse --delete --verbose \
          --exclude .git/ \
          --exclude .github/ \
          --exclude node_modules/ \
          --exclude verify_*.sh \
          --exclude cookies.txt \
          . /htdocs/;
        bye;
        "
          
    - name: Initialize Database
      run: |
        echo "Database will be initialized on first access via setup_database.php"
        echo "Visit: https://your-domain.com/setup_database.php after deployment"
        
    - name: Deployment Complete
      run: |
        echo "✓ Deployment successful!"
        echo "✓ .env file created with database credentials"
        echo "✓ Files uploaded to server"
        echo ""
        echo "Next steps:"
        echo "1. Visit https://your-domain.com/setup_database.php (one time only)"
        echo "2. Login to admin panel: https://your-domain.com/public/admin.php"
        echo "3. Default credentials: admin / admin123"
